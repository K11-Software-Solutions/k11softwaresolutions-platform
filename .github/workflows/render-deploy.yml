name: Deploy to Render

on:
  push:
    branches: [ main ]

jobs:
  render-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Deploy using Render REST API
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -euo pipefail
          echo "Reading service name from render.yaml"
          SERVICE_NAME=$(grep -E '^\s*-?\s*name:' render.yaml | head -n1 | awk '{print $2}')
          echo "Service name: $SERVICE_NAME"
          echo "Querying Render for service id..."
          SERVICE_ID=$(curl -sS -H "Authorization: Bearer $RENDER_API_KEY" https://api.render.com/v1/services | python3 -c "import sys,json,os; name=os.environ['SERVICE_NAME']; arr=json.load(sys.stdin); ids=[s.get('id') for s in arr if s.get('name')==name]; print(ids[0] if ids else '')")
          if [ -z "$SERVICE_ID" ]; then
            echo "Service not found via API for name: $SERVICE_NAME"
            exit 1
          fi
          echo "Triggering deploy for service id: $SERVICE_ID"
          curl -sS -X POST -H "Authorization: Bearer $RENDER_API_KEY" -H "Content-Type: application/json" https://api.render.com/v1/services/$SERVICE_ID/deploys -d '{}' | python3 -m json.tool

      - name: Notify
        run: echo "Render deploy step finished (check Render dashboard)."
